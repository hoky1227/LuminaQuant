name: ci

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup uv
        uses: astral-sh/setup-uv@v6

      - name: Sync dependencies
        run: uv sync --extra optimize --extra dev --extra live

      - name: Ruff lint check
        run: uv run ruff check .

      - name: Architecture check
        run: uv run python scripts/check_architecture.py

      - name: Hardcoded parameter audit
        run: uv run python scripts/audit_hardcoded_params.py

      - name: Documentation verification (EN/KR + docs)
        run: uv run python scripts/verify_docs.py

      - name: Run pytest suite
        run: |
          uv run pytest \
            tests/test_audit_hardcoded_params.py \
            tests/test_compute_engine.py \
            tests/test_timeframe_panel_and_liquidity.py \
            tests/test_native_backend.py \
            tests/test_optimize_two_stage.py \
            tests/test_message_bus.py \
            tests/test_runtime_cache.py \
            tests/test_system_assembly.py \
            tests/test_ohlcv_loader.py \
            tests/test_execution_protective_orders.py \
            tests/test_live_execution_state_machine.py \
            tests/test_lookahead.py \
            tests/test_publish_public_pr.py \
            tests/test_readme_quickstart_paths.py \
            tests/test_verify_8gb_baseline_script.py

      - name: Benchmark smoke + 8GB baseline gate
        run: |
          mkdir -p logs reports/benchmarks
          /usr/bin/time -v \
            uv run python scripts/benchmark_backtest.py --iters 1 --warmup 0 --output reports/benchmarks/ci_smoke.json \
            2>&1 | tee logs/ci_smoke.time.log
          uv run python scripts/verify_8gb_baseline.py \
            --benchmark reports/benchmarks/ci_smoke.json \
            --time-log logs/ci_smoke.time.log \
            --oom-log logs/ci_smoke.time.log \
            --skip-dmesg \
            --output reports/benchmarks/ci_smoke_8gb_gate.json

  gpu-runtime-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup uv
        uses: astral-sh/setup-uv@v6

      - name: Sync GPU dependencies
        run: uv sync --extra dev --extra gpu

      - name: Verify GPU adapter behavior
        run: |
          uv run python - <<'PY'
          import importlib.util
          import polars as pl

          from lumina_quant.compute_engine import (
              detect_nvidia_gpu,
              polars_gpu_available,
              select_engine,
          )

          assert importlib.util.find_spec("cudf_polars") is not None
          assert hasattr(pl, "GPUEngine")

          nvidia_ok, nvidia_reason = detect_nvidia_gpu()
          print(f"nvidia_ok={nvidia_ok} reason={nvidia_reason}")

          smoke_ok, smoke_reason = polars_gpu_available(device=None, smoke_test=nvidia_ok)
          print(f"smoke_ok={smoke_ok} reason={smoke_reason}")

          engine = select_engine(mode="auto")
          print(f"auto_resolved={engine.resolved_engine} reason={engine.reason}")

          if nvidia_ok:
            assert smoke_ok, smoke_reason
            assert engine.resolved_engine == "gpu"
          else:
            assert engine.resolved_engine == "cpu"
          PY
